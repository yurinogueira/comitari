version: "3.8"

x-service_defaults: &django_default
  env_file: ./config/.env
  image: ngrtec/comitari:0.2.4
  restart: "unless-stopped"
  volumes:
    - ./backend/backends:/app/backends
    - ./backend/comitari:/app/comitari
    - ./backend/core:/app/core
    - ./backend/static:/app/static
    - ./backend/users:/app/users
    - ./backend/conftest.py:/app/conftest.py
    - ./backend/manage.py:/app/manage.py
    - ./backend/poetry.lock:/app/poetry.lock
    - ./backend/pyproject.toml:/app/pyproject.toml
    - ./backend/README.md:/app/README.md
  networks:
    - comitari-network

services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres-container
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - comitari-network
    env_file: ./config/.env

  redis:
    image: redis:7-alpine
    container_name: redis-container
    volumes:
      - redis-data:/data
    networks:
      - comitari-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq-container
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - comitari-network

  api:
    <<: *django_default
    container_name: api
    stop_grace_period: "5s"
    environment:
      COMMAND: development
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis

  worker:
    <<: *django_default
    deploy:
      mode: replicated
      replicas: 2
    stop_grace_period: "5s"
    environment:
      COMMAND: worker
    depends_on:
      - api
      - postgres
      - redis

  beat:
    <<: *django_default
    container_name: beat
    stop_grace_period: "5s"
    environment:
      COMMAND: beat
    depends_on:
      - api
      - postgres
      - redis
      - rabbitmq

networks:
  comitari-network:

volumes:
  postgres-data:
  redis-data:
